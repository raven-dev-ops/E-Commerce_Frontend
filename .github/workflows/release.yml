name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Typecheck
        run: npm run typecheck

      - name: Unit tests
        run: npm run test

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: E2E tests
        run: npm run test:e2e

  publish:
    needs: verify
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract changelog notes
        id: changelog
        run: |
          notes=$(node - <<'NODE'
          const fs = require('fs');

          const tag = process.env.GITHUB_REF_NAME || '';
          const version = tag.replace(/^v/, '');
          if (!version) {
            console.error('Missing version tag.');
            process.exit(1);
          }

          const changelog = fs.readFileSync('CHANGELOG.md', 'utf8');
          const normalized = changelog.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
          const escaped = version.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const header = new RegExp(`^## \\[${escaped}\\] - .*?$`, 'm');
          const match = normalized.match(header);
          let start = -1;
          let prefix = '';

          if (match && match.index !== undefined) {
            start = match.index + match[0].length;
          } else if (version.includes('-')) {
            const unreleasedIndex = normalized.indexOf('## [Unreleased]');
            if (unreleasedIndex === -1) {
              console.error('No CHANGELOG.md entry for Unreleased.');
              process.exit(1);
            }
            start = unreleasedIndex + '## [Unreleased]'.length;
            prefix = `Release candidate for ${tag}.\\n\\n`;
          } else {
            console.error(`No CHANGELOG.md entry for ${version}.`);
            process.exit(1);
          }

          const rest = normalized.slice(start);
          const nextHeader = new RegExp('^## \\[', 'm');
          const next = rest.search(nextHeader);
          const notes = (next === -1 ? rest : rest.slice(0, next)).trim() || 'No changelog entries.';
          const body = `${prefix}${notes}`.trim();

          console.log(body.replace(/\r/g, ''));
          NODE
          )

          {
            echo "notes<<EOF"
            printf '%s\n' "$notes"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          body: ${{ steps.changelog.outputs.notes }}
          prerelease: ${{ contains(github.ref_name, '-') }}
