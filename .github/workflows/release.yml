name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract changelog notes
        id: changelog
        run: |
          node - <<'NODE'
          const fs = require('fs');

          const tag = process.env.GITHUB_REF_NAME || '';
          const version = tag.replace(/^v/, '');
          if (!version) {
            console.error('Missing version tag.');
            process.exit(1);
          }

          const changelog = fs.readFileSync('CHANGELOG.md', 'utf8');
          const escaped = version.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const header = new RegExp(`^## \\[${escaped}\\] - .*?$`, 'm');
          const match = changelog.match(header);
          let start = -1;
          let prefix = '';

          if (match && match.index !== undefined) {
            start = match.index + match[0].length;
          } else if (version.includes('-')) {
            const unreleased = changelog.match(/^## \\[Unreleased\\]/m);
            if (!unreleased || unreleased.index === undefined) {
              console.error('No CHANGELOG.md entry for Unreleased.');
              process.exit(1);
            }
            start = unreleased.index + unreleased[0].length;
            prefix = `Release candidate for ${tag}.\\n\\n`;
          } else {
            console.error(`No CHANGELOG.md entry for ${version}.`);
            process.exit(1);
          }

          const rest = changelog.slice(start);
          const nextHeader = new RegExp('^## \\[', 'm');
          const next = rest.search(nextHeader);
          const notes = (next === -1 ? rest : rest.slice(0, next)).trim() || 'No changelog entries.';
          const body = `${prefix}${notes}`.trim();

          const output = process.env.GITHUB_OUTPUT;
          fs.appendFileSync(output, `notes<<'EOF'\\n${body}\\nEOF\\n`);
          NODE

      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          body: ${{ steps.changelog.outputs.notes }}
